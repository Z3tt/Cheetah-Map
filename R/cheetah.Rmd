---
title: "Cheetah Map"
description: |
    A Contribution to the BES Movement "MoveMap" Competition 2021.
author:
    - name: Cédric Scherer
url: https://www.cedricscherer.com  
affiliation: Self-Employed | IZW Berlin
- name: Jörg Melzheimer
url: https://www.cheetah-research.org/joerg-melzheimer
affiliation: IZW Berlin
affiliation_url: http://www.izw-berlin.de/en/
    date: "`r Sys.Date()`"
output: 
    distill::distill_article:
    highlight: kate       ## choose code style
code_folding: hide    ## hide or show code by default?
code_download: true 
editor_options: 
    chunk_output_type: console
---
    
    ```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, fig.showtext = TRUE, retina = 1)
Sys.setlocale("LC_TIME", "C")
```

```{r packages}
library(tidyverse)
library(sf)
library(systemfonts)
library(purrr)
library(here)
library(glue)
library(colorspace)
```


## Data

```{r prep-data}
proj <- "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"
```


### Communication Hubs

```{r data-hubs}
## 0 Communication hub borders
path <- here("data", "0 Communication hub borders")

## KDE's from Jörg
sf_kde50 <- st_read(dsn = glue("{path}/KDE50/P068kde50_tgf.shp")) %>% 
  st_transform(crs = proj)
sf_kde95 <- st_read(dsn = glue("{path}/KDE95/P068kde95_tgf.shp")) %>% 
  st_transform(crs = proj)

## Calculate KDEs new
# terri <- read_csv(glue("{path}/Terri raw data/P068_tgf.csv")) %>% 
#   dplyr::select(`location.long`, `location.lat`) %>% 
#   SpatialPoints()
# 
# proj4string(terri) = CRS(proj)
# ud <- kernelUD(terri, extent = .1)
# 
# vers <- function(r) {
#   getverticeshr(ud, r, unout = "km2") %>% 
#     st_as_sf() 
# }
# 
# kdes <- map_df(rev(seq(50, 95, by = 5)), vers)
```

### Trees

```{r data-trees}
## 1 marking trees
sf_trees <- st_read(dsn = here("data", "1 marking trees", "mt_201022.shp")) %>% 
  st_transform(crs = proj) 
```

### Floaters

```{r data-floaters}
## 2 floaters
ids <- 
  list.files(path = here("data", "2 floaters"), full.names = FALSE) %>% 
  as_tibble() %>% 
  mutate(
    ## remove file format
    id = str_remove(value, ".csv"), 
    filename = as.character(1:n())
  ) %>% 
  dplyr::select(-value)

df_floaters <- 
  list.files(path = here("data", "2 floaters"), full.names = TRUE) %>%
  map_dfr(read_csv, .id = "filename") %>% 
  janitor::clean_names() %>% 
  left_join(ids) %>% 
  dplyr::select(id, event_id:location_lat, 
                tag_local_identifier, individual_local_identifier) %>% 
  group_by(id) %>% 
  mutate(step = 1:n())

sf_floaters <- 
  df_floaters %>% 
  filter(
    !is.na(location_long), !is.na(location_lat),
    id %in% c("P151-5552", "P152-7077", "P153-7417"), #"P150-6409", "P155-3534"
  ) %>% 
  mutate(
    year = lubridate::year(timestamp), 
    month = lubridate::month(timestamp),
    yday = lubridate::yday(timestamp)
  ) %>% 
  st_as_sf(coords = c("location_long", "location_lat"), crs = proj)
```

```{r images}
img_tree <- grid::rasterGrob(png::readPNG(here("img", "tree.png")), interpolate = TRUE)
```


## Map P Hub

```{r map-prep}
## ggplot theme
theme_set(theme_light(base_size = 14, base_family = "Proxima Nova"))

theme_update(
  panel.grid.major = element_line(size = .3, color = "#ead2ae"),
  panel.grid.minor = element_blank(),
  panel.background = element_rect(fill = "#f6ecdd")
)

## color palette
pal <- rcartocolor::carto_pal(n = 4, name = "Bold")[1:3]

## map projection (UTM S33)
map_proj <- "+proj=utm +zone=33 +south +ellps=bess_nam +towgs84=616,97,-251,0,0,0,0 +units=m +no_defs"

## background and main data (+ turn into trajectories)
sf_all_line <-
  sf_floaters %>% 
  filter(
    #(year == 2020 & month %in% 11:12) | (year == 2021)
    (year == 2020 & month %in% 2:12) | (year == 2021)
  ) %>%
  group_by(id)  %>%
  summarise(do_union = FALSE) %>%
  st_cast("LINESTRING")

sf_highlight <-
  sf_floaters %>% 
  filter(yday %in% 348:366 & year == 2020)

sf_highlight_line <-
  sf_floaters %>% 
  filter(yday %in% 348:366 & year == 2020) %>% 
  group_by(id)  %>%
  summarise(do_union = FALSE) %>%
  st_cast("LINESTRING")
```

```{r map-overview}
## overview 
map <- 
  sf_all_line %>% 
  ggplot() + 
    ## KDE95 Fill --------------------------------------------------------------
    geom_sf(data = sf_kde95, fill = "#ead2ae", color = NA) +
    ## Trajectories Outline ----------------------------------------------------
    geom_sf(data = sf_all_line, color = "white", size = 1.5) + 
    geom_sf(data = sf_highlight_line, color = "white", size = 2.3) + 
    ## Trajectories Background -------------------------------------------------
    geom_sf(
      aes(color = id, color = after_scale(desaturate(lighten(color, .7), .5))),
      size = .8
    ) +
    ## KDE95 Outline -----------------------------------------------------------
    geom_sf(data = sf_kde95, fill = NA, color = "grey40", size = .5, linetype = "11") +
    ## Trajectories Highlight --------------------------------------------------
    geom_sf(data = sf_highlight_line, aes(color = id), size = .8) + 
    ## KDE50 Outline -----------------------------------------------------------
    geom_sf(data = sf_kde50, color = "black", fill = NA, linetype = "11", size = .7) +
    # geom_sf_label(
    #   data = sf_p_highlight %>% group_by(id, yday) %>% slice(1),
    #   aes(color = id, label = yday)
    # ) +
    coord_sf(xlim = c(17.2, NA), ylim = c(-22.4, -21.5), crs = map_proj) +
    scale_color_manual(values = pal) +
    ggsave(here::here("plots", "dev", glue("{format(Sys.time(), '%Y%m%d_%H%M%S')}_cheetah.pdf")), 
           width = 15, height = 15, device = cairo_pdf)
```

```{r map-P-hub}
map <- 
  sf_all_line %>% 
  ggplot() + 
    ## Observations Outline ----------------------------------------------------
    geom_sf(data = sf_highlight, color = "white", size = 4.5) +
    ## Trajectories Outline ----------------------------------------------------
    geom_sf(data = sf_highlight_line, color = "white", size = 2.7) +
    ## Trajectories ------------------------------------------------------------
    geom_sf(data = sf_highlight_line, aes(color = id), size = 1.4, alpha = .3) +
    ## Observations ------------------------------------------------------------
    geom_sf(data = sf_highlight, aes(color = id), 
            size = 2.2, shape = 21, fill = "#f6ecdd", stroke = 1.4) +
    ## KDE50 Outline -----------------------------------------------------------
    geom_sf(data = sf_kde50, color = "black", fill = NA, linetype = "22", size = .7) +
    coord_sf(xlim = c(17.71, 17.76), ylim = c(-21.835, -21.79), crs = map_proj) +
    scale_color_manual(values = pal) +
    ggsave(here::here("plots", "dev", glue("{format(Sys.time(), '%Y%m%d_%H%M%S')}_cheetah.pdf")), 
           width = 15, height = 15, device = cairo_pdf)
```

```{r convert-pdf}
pdfs <- list.files(here("plots"), pattern = "*.pdf")
setwd(here("plots"))
for(pdf in pdfs) {
    pdf_convert(pdf = here("plots", pdf),
                format = "png", dpi = 300)
}
```


<details><summary>Session Info</summary>
    
    ```{r sessionInfo, echo = F}
Sys.time()
git2r::repository()
sessionInfo()
```

</details>
    